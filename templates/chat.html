<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/styles.css">
    <title>Flipkart AI Chatbot</title>
</head>
<body>
    <div class="chatbot-header">
        <h1>Flipkart AI Chatbot</h1>
        <button class="close-btn" onclick="closeChat()">âœ–</button>
    </div>
    <div class="container">
        <div class="product-input-section">
            <input type="text" id="product-category" placeholder="Enter product category...">
            <button onclick="getInformation()">Get Information</button>
        </div>
        <div id="status-message" class="status-message"></div>
        <button onclick="toggleTableVisibility()">View Scrapped Details</button>
        <div id="data-table-container" class="data-table-container" style="display:none;">
            <div id="data-table" class="data-table"></div>
        </div>
        <button onclick="ingestData()">Ingest Data</button>
        <div id="chat-box" class="chat-box">
            <!-- Chat messages will be inserted here -->
        </div>
        <div class="input-section">
            <input type="text" id="user-input" placeholder="Ask about Flipkart products...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        function closeChat() {
            alert("Chat closed.");
        }

        async function getInformation() {
            const productCategory = document.getElementById('product-category').value;
            if (!productCategory) {
                alert("Please enter a product category!");
                return;
            }

            document.getElementById('status-message').innerHTML = "ðŸ•’ Gathering information is in progress...";
            const response = await fetch(`/scrape/${productCategory}`, { method: 'POST' });
            const data = await response.json();
            document.getElementById('status-message').innerHTML = "âœ… Information gathered successfully!";
            displayData(data.data);
        }

        function displayData(data) {
            let tableHtml = '<table>';
            tableHtml += '<tr><th>Title</th><th>Price</th><th>Rating</th><th>Highlights</th><th>Description</th><th>Reviews</th><th>Link</th></tr>';
            data.forEach(item => {
                tableHtml += `<tr>
                                <td>${item.product_title}</td>
                                <td>${item.product_price}</td>
                                <td>${item.product_rating}</td>
                                <td>${item.product_highlights}</td>
                                <td>${item.product_description}</td>
                                <td>${item.product_reviews}</td>
                                <td><a href="${item.product_link}" target="_blank">View Product</a></td>
                            </tr>`;
            });
            tableHtml += '</table>';
            document.getElementById('data-table').innerHTML = tableHtml;
        }

        async function getInformation() {
                const productCategory = document.getElementById('product-category').value;
                if (!productCategory) {
                    alert("Please enter a product category!");
                    return;
                }

                document.getElementById('status-message').innerHTML = "ðŸ•’ Gathering information is in progress...";
                const response = await fetch(`/scrape/${productCategory}`, { method: 'POST' });
                const data = await response.json();
                document.getElementById('status-message').innerHTML = "âœ… Information gathered successfully!";
                displayData(data.data);
            }
        function toggleTableVisibility() {
            const container = document.getElementById('data-table-container');
            const button = document.querySelector('button[onclick="toggleTableVisibility()"]');
            if (container.style.display === "none") {
                container.style.display = "block";
                button.innerText = "Hide Scrapped Details";
            } else {
                container.style.display = "none";
                button.innerText = "View Scrapped Details";
            }
        }

        async function ingestData() {
            const response = await fetch('/ingest', { method: 'POST' });
            const data = await response.json();
            alert(data.message);
        }

        async function sendMessage() {
            const input = document.getElementById('user-input').value;
            if (!input) return;

            const chatBox = document.getElementById('chat-box');
            const timestamp = new Date().toLocaleTimeString();
            chatBox.innerHTML += `<div class="message user-message"><div class="icon-container"><img src="/static/assets/user.png" class="icon"></div><div class="message-content">${input}<span class="timestamp">${timestamp}</span></div></div>`;

            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: input })
            });
            const data = await response.json();
            chatBox.innerHTML += `<div class="message assistant-message"><div class="icon-container"><img src="/static/assets/bot.png" class="icon"></div><div class="message-content">${data.response}<span class="timestamp">${timestamp}</span></div></div>`;
            document.getElementById('user-input').value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>